<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byrnecut Q&A Session</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F5A623; min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: #F5A623; color: #2D2D2D; padding: 30px; text-align: center; }
        .logo { width: 120px; height: auto; margin-bottom: 20px; }
        .header h1 { font-size: 28px; margin-bottom: 10px; font-weight: 700; }
        .header p { opacity: 0.9; font-size: 16px; }
        .content { padding: 30px; }
        .login-form, .question-form { display: flex; flex-direction: column; gap: 20px; }
        .login-form { max-width: 400px; margin: 0 auto; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: 600; color: #2D2D2D; font-size: 14px; }
        .char-counter { font-size: 12px; color: #666; text-align: right; }
        .char-counter.warning { color: #F5A623; }
        .char-counter.error { color: #dc3545; }
        input, textarea { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; font-family: inherit; transition: border-color 0.3s; }
        input:focus, textarea:focus { outline: none; border-color: #F5A623; }
        textarea { min-height: 120px; resize: vertical; }
        button { background: #F5A623; color: #2D2D2D; border: none; padding: 14px 28px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(245, 166, 35, 0.4); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .success-message, .error-message, .info-message { padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .success-message { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error-message { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info-message { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .closed-message { text-align: center; padding: 40px 20px; }
        .closed-message svg { width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.3; }
        .moderator-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; flex-wrap: wrap; gap: 10px; }
        .session-status { display: flex; align-items: center; gap: 10px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #28a745; }
        .status-indicator.closed { background: #dc3545; }
        .moderator-controls, .control-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .moderator-controls button, .control-group button { flex: 1; min-width: 120px; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-approve { background: #28a745; color: white; }
        .btn-reject { background: #dc3545; color: white; }
        .btn-answer { background: #6c757d; color: white; }
        .question-list { display: flex; flex-direction: column; gap: 15px; }
        .question-card { border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; }
        .question-card.pending { border-left: 4px solid #F5A623; }
        .question-card.approved { border-left: 4px solid #28a745; background: #f8fff9; }
        .question-card.answered { border-left: 4px solid #6c757d; background: #f8f9fa; opacity: 0.7; }
        .question-header { display: flex; justify-content: space-between; margin-bottom: 12px; gap: 10px; }
        .question-meta { font-size: 12px; color: #666; }
        .question-status { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-answered { background: #e2e3e5; color: #383d41; }
        .question-text { font-size: 16px; color: #2D2D2D; margin-bottom: 12px; line-height: 1.5; }
        .question-name { font-size: 14px; color: #666; font-style: italic; margin-bottom: 12px; }
        .question-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .question-actions button { padding: 8px 16px; font-size: 14px; flex: 0; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state svg { width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.3; }
        .display-view { background: #2D2D2D; min-height: 100vh; padding: 40px; }
        .display-container { max-width: 1200px; margin: 0 auto; }
        .display-header { text-align: center; margin-bottom: 40px; }
        .display-logo { width: 200px; height: auto; margin-bottom: 20px; }
        .display-title { color: #F5A623; font-size: 48px; font-weight: 700; }
        .display-question { background: white; border-radius: 12px; padding: 40px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border-left: 8px solid #F5A623; }
        .display-question-text { font-size: 28px; color: #2D2D2D; line-height: 1.6; margin-bottom: 20px; }
        .display-question-name { font-size: 18px; color: #666; font-style: italic; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Confirm Action</h2>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button onclick="window.closeModal()" class="btn-secondary">Cancel</button>
                <button id="modalConfirm" class="btn-danger">Confirm</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, remove, update, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const app = initializeApp({
            apiKey: "AIzaSyCoXUndzA5tynEW0LV7_nldit1Jx-wZXVU",
            authDomain: "conference-qa-2375a.firebaseapp.com",
            databaseURL: "https://conference-qa-2375a-default-rtdb.firebaseio.com",
            projectId: "conference-qa-2375a",
            storageBucket: "conference-qa-2375a.firebasestorage.app",
            messagingSenderId: "911059882084",
            appId: "1:911059882084:web:91ffa97c1f7564e695cf71"
        });
        
        const database = getDatabase(app);
        const questionsRef = ref(database, 'questions');
        const settingsRef = ref(database, 'settings');
        const appDiv = document.getElementById('app');
        const urlParams = new URLSearchParams(window.location.search);
        const isModerator = urlParams.get('moderator') === 'true';
        const isDisplay = urlParams.get('display') === 'true';
        const MAX_QUESTION_LENGTH = 500;
        const RATE_LIMIT_MINUTES = 1;
        const logoSVG = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' rx='20' fill='%23F5A623'/%3E%3Ccircle cx='35' cy='35' r='12' fill='%232D2D2D'/%3E%3Ccircle cx='165' cy='35' r='12' fill='%232D2D2D'/%3E%3Ccircle cx='100' cy='55' r='12' fill='%232D2D2D'/%3E%3Ccircle cx='35' cy='100' r='12' fill='%232D2D2D'/%3E%3Ccircle cx='70' cy='100' r='12' fill='white' stroke='%232D2D2D' stroke-width='2'/%3E%3Ccircle cx='100' cy='100' r='12' fill='%232D2D2D'/%3E%3Ccircle cx='130' cy='100' r='12' fill='white' stroke='%232D2D2D' stroke-width='2'/%3E%3Ccircle cx='165' cy='100' r='12' fill='%232D2D2D'/%3E%3Ccircle cx='100' cy='145' r='12' fill='%232D2D2D'/%3E%3Ccircle cx='35' cy='165' r='12' fill='%232D2D2D'/%3E%3Ccircle cx='165' cy='165' r='12' fill='%232D2D2D'/%3E%3C/svg%3E`;
        
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        async function getPasswordHash() {
            const snapshot = await get(ref(database, 'settings/passwordHash'));
            return snapshot.val() || 'a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3';
        }
        
        function checkRateLimit() {
            const lastSubmit = localStorage.getItem('lastQuestionSubmit');
            if (!lastSubmit) return true;
            return (Date.now() - parseInt(lastSubmit)) / (1000 * 60) >= RATE_LIMIT_MINUTES;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        window.closeModal = () => document.getElementById('modal').classList.remove('active');
        
        function showModal(title, message, onConfirm) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modal').classList.add('active');
            const btn = document.getElementById('modalConfirm');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => { onConfirm(); window.closeModal(); };
        }
        
        async function renderAudienceView() {
            const snapshot = await get(settingsRef);
            const sessionOpen = snapshot.val()?.sessionOpen !== false;
            
            if (!sessionOpen) {
                appDiv.innerHTML = `<div class="container"><div class="header"><img src="${logoSVG}" class="logo"><h1>Q&A Session</h1></div><div class="content"><div class="closed-message"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg><h2>Question Submission Closed</h2></div></div></div>`;
                return;
            }
            
            const canSubmit = checkRateLimit();
            const lastSubmit = localStorage.getItem('lastQuestionSubmit');
            const remaining = lastSubmit ? Math.ceil(((RATE_LIMIT_MINUTES * 60 * 1000) - (Date.now() - parseInt(lastSubmit))) / 1000) : 0;
            
            appDiv.innerHTML = `<div class="container"><div class="header"><img src="${logoSVG}" class="logo"><h1>Submit Your Question</h1><p>Your question will be reviewed before being shown to the speaker</p></div><div class="content"><form class="question-form" id="questionForm"><div class="form-group"><label for="name">Your Name (Optional)</label><input type="text" id="name" placeholder="Anonymous"></div><div class="form-group"><label for="question">Your Question * (Max ${MAX_QUESTION_LENGTH} characters)</label><textarea id="question" placeholder="Type your question here..." required maxlength="${MAX_QUESTION_LENGTH}"></textarea><div class="char-counter" id="charCounter">0 / ${MAX_QUESTION_LENGTH}</div></div>${!canSubmit ? `<div class="info-message">Please wait <span id="countdown">${remaining}</span> seconds before submitting another question.</div>` : ''}<button type="submit" id="submitBtn" ${!canSubmit ? 'disabled' : ''}>Submit Question</button><div id="message"></div></form></div></div>`;
            
            if (!canSubmit && remaining > 0) {
                const countdownEl = document.getElementById('countdown');
                const timer = setInterval(() => {
                    const ls = localStorage.getItem('lastQuestionSubmit');
                    if (!ls) { clearInterval(timer); renderAudienceView(); return; }
                    const rem = Math.ceil(((RATE_LIMIT_MINUTES * 60 * 1000) - (Date.now() - parseInt(ls))) / 1000);
                    if (rem <= 0) { clearInterval(timer); renderAudienceView(); return; }
                    if (countdownEl) countdownEl.textContent = rem;
                }, 1000);
            }
            
            const textarea = document.getElementById('question');
            const counter = document.getElementById('charCounter');
            textarea.addEventListener('input', () => {
                const len = textarea.value.length;
                counter.textContent = `${len} / ${MAX_QUESTION_LENGTH}`;
                counter.classList.remove('warning', 'error');
                if (len > MAX_QUESTION_LENGTH * 0.9) counter.classList.add('error');
                else if (len > MAX_QUESTION_LENGTH * 0.7) counter.classList.add('warning');
            });
            
            document.getElementById('questionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!checkRateLimit()) return;
                const btn = document.getElementById('submitBtn');
                const msg = document.getElementById('message');
                const name = document.getElementById('name').value.trim() || 'Anonymous';
                const question = document.getElementById('question').value.trim();
                btn.disabled = true;
                btn.textContent = 'Submitting...';
                try {
                    await set(push(questionsRef), { name, question, timestamp: Date.now(), status: 'pending' });
                    localStorage.setItem('lastQuestionSubmit', Date.now().toString());
                    msg.innerHTML = '<div class="success-message">✓ Question submitted successfully!</div>';
                    setTimeout(() => renderAudienceView(), 2000);
                } catch (error) {
                    msg.innerHTML = '<div class="error-message">Error submitting question.</div>';
                    btn.disabled = false;
                    btn.textContent = 'Submit Question';
                }
            });
        }
        
        function renderModeratorLogin() {
            appDiv.innerHTML = `<div class="container"><div class="header"><img src="${logoSVG}" class="logo"><h1>Moderator Login</h1></div><div class="content"><form class="login-form" id="loginForm"><div class="form-group"><label for="password">Password</label><input type="password" id="password" required></div><button type="submit">Login</button><div id="loginMessage"></div></form></div></div>`;
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const hash = await hashPassword(document.getElementById('password').value);
                const stored = await getPasswordHash();
                if (hash === stored) {
                    sessionStorage.setItem('moderatorAuth', 'true');
                    renderModeratorView();
                } else {
                    document.getElementById('loginMessage').innerHTML = '<div class="error-message">Incorrect password</div>';
                }
            });
        }
        
        let currentFilter = 'all', allQuestions = {}, sessionOpen = true;
        
        async function renderModeratorView() {
            if (sessionStorage.getItem('moderatorAuth') !== 'true') { renderModeratorLogin(); return; }
            appDiv.innerHTML = `<div class="container"><div class="header"><img src="${logoSVG}" class="logo"><h1>Moderator Dashboard</h1></div><div class="content"><div class="moderator-header"><div class="session-status"><span class="status-indicator" id="statusIndicator"></span><span id="statusText">Session Open</span></div><button onclick="window.logout()" class="btn-secondary">Logout</button></div><div class="control-group"><button onclick="window.toggleSession()" id="toggleSessionBtn">Close Session</button><button onclick="window.archiveAndClear()" class="btn-danger">Archive & Clear</button><button onclick="window.downloadQuestions()" class="btn-secondary">Download CSV</button></div><div class="moderator-controls"><button onclick="window.filterQuestions('all')" id="filterAll">All</button><button onclick="window.filterQuestions('pending')" id="filterPending">Pending</button><button onclick="window.filterQuestions('approved')" id="filterApproved">Approved</button></div><div id="questionList" class="loading">Loading...</div></div></div>`;
            onValue(settingsRef, (s) => {
                sessionOpen = s.val()?.sessionOpen !== false;
                const ind = document.getElementById('statusIndicator');
                const txt = document.getElementById('statusText');
                const btn = document.getElementById('toggleSessionBtn');
                if (ind && txt && btn) {
                    if (sessionOpen) { ind.classList.remove('closed'); txt.textContent = 'Session Open'; btn.textContent = 'Close Session'; btn.className = 'btn-danger'; }
                    else { ind.classList.add('closed'); txt.textContent = 'Session Closed'; btn.textContent = 'Open Session'; btn.className = 'btn-success'; }
                }
            });
            onValue(questionsRef, (s) => { allQuestions = s.val() || {}; displayQuestions(); });
        }
        
        window.logout = () => { sessionStorage.removeItem('moderatorAuth'); renderModeratorLogin(); };
        window.toggleSession = async () => await set(ref(database, 'settings/sessionOpen'), !sessionOpen);
        window.archiveAndClear = () => showModal('Archive & Clear', 'Save to archive and clear all?', async () => {
            const t = Date.now();
            if (Object.keys(allQuestions).length > 0) await set(ref(database, `archive/session_${t}`), { timestamp: t, date: new Date(t).toISOString(), questions: allQuestions });
            await remove(questionsRef);
        });
        window.downloadQuestions = () => {
            const q = Object.entries(allQuestions).map(([id, d]) => ({ ...d, date: new Date(d.timestamp).toISOString() }));
            const csv = [['Date', 'Name', 'Question', 'Status'], ...q.map(x => [x.date, x.name, x.question.replace(/"/g, '""'), x.status])].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qa_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };
        window.filterQuestions = (f) => {
            currentFilter = f;
            ['filterAll', 'filterPending', 'filterApproved'].forEach(id => {
                const b = document.getElementById(id);
                if (b) { b.style.opacity = '1'; b.style.fontWeight = 'normal'; }
            });
            const active = document.getElementById('filter' + f.charAt(0).toUpperCase() + f.slice(1));
            if (active) { active.style.opacity = '0.8'; active.style.fontWeight = '700'; }
            displayQuestions();
        };
        window.approveQuestion = async (id) => await update(ref(database, `questions/${id}`), { status: 'approved' });
        window.rejectQuestion = (id) => showModal('Delete', 'Delete this question?', async () => await remove(ref(database, `questions/${id}`)));
        window.markAnswered = async (id) => await update(ref(database, `questions/${id}`), { status: 'answered' });
        
        function displayQuestions() {
            const list = document.getElementById('questionList');
            if (!list) return;
            const entries = Object.entries(allQuestions).map(([id, q]) => ({ id, ...q })).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            const filtered = entries.filter(q => currentFilter === 'all' || q.status === currentFilter);
            if (filtered.length === 0) {
                list.innerHTML = `<div class="empty-state"><h3>No questions</h3></div>`;
                return;
            }
            list.innerHTML = filtered.map(q => {
                const s = ['pending', 'approved', 'answered'].includes(q.status) ? q.status : 'pending';
                const actions = s === 'pending' ? `<button class="btn-approve" onclick="window.approveQuestion('${q.id}')">Approve</button><button class="btn-reject" onclick="window.rejectQuestion('${q.id}')">Reject</button>` : s === 'approved' ? `<button class="btn-answer" onclick="window.markAnswered('${q.id}')">Mark Answered</button><button class="btn-reject" onclick="window.rejectQuestion('${q.id}')">Delete</button>` : `<button class="btn-reject" onclick="window.rejectQuestion('${q.id}')">Delete</button>`;
                return `<div class="question-card ${s}"><div class="question-header"><div class="question-meta">${new Date(q.timestamp).toLocaleString()}</div><span class="question-status status-${s}">${s}</span></div><div class="question-text">${escapeHtml(q.question || '')}</div><div class="question-name">— ${escapeHtml(q.name || 'Anonymous')}</div><div class="question-actions">${actions}</div></div>`;
            }).join('');
        }
        
        function renderDisplayView() {
            document.body.style.padding = '0';
            document.body.style.background = '#2D2D2D';
            appDiv.innerHTML = `<div class="display-view"><div class="display-container"><div class="display-header"><img src="${logoSVG}" class="display-logo"><div class="display-title">Q&A</div></div><div id="displayQuestions" class="loading">Loading...</div></div></div>`;
            const host = document.getElementById('displayQuestions');
            onValue(questionsRef, (s) => {
                const approved = Object.entries(s.val() || {}).map(([id, q]) => ({ id, ...q })).filter(q => q.status === 'approved').sort((a, b) => a.timestamp - b.timestamp);
                if (approved.length === 0) { host.innerHTML = `<div class="display-question"><div class="display-question-text">No approved questions yet.</div></div>`; return; }
                host.innerHTML = approved.map(q => `<div class="display-question"><div class="display-question-text">${escapeHtml(q.question || '')}</div><div class="display-question-name">— ${escapeHtml(q.name || 'Anonymous')}</div></div>`).join('');
            });
        }
        
        if (isDisplay) renderDisplayView();
        else if (isModerator) renderModeratorView();
        else renderAudienceView();
    </script>
</body>
</html>
